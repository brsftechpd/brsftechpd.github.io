<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSON Editor</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #f8fafc;
            --text-white: #ffffff;
            --text-secondary: #e2e8f0;
            --text-muted: #94a3b8;
            --border-color: #334155;
            --border-focus: #475569;
            
            --color-primary: #6366f1;
            --color-success: #10b981;
            --color-danger: #ef4444;
            --color-warning: #f59e0b;
            --color-info: #3b82f6;
            
            --gradient-primary: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
            --gradient-success: linear-gradient(135deg, #10b981 0%, #059669 100%);
            --gradient-danger: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            --gradient-waiting: linear-gradient(135deg, #64748b 0%, #475569 100%);
            --gradient-warning: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            --gradient-info: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            
            --shadow-lg: 0 20px 40px rgba(0, 0, 0, 0.4);
            --shadow-md: 0 8px 20px rgba(0, 0, 0, 0.3);
            --border-radius: 12px;
            --border-radius-lg: 16px;
            --spacing-sm: 12px;
            --spacing-md: 16px;
            --spacing-lg: 20px;
            --spacing-xl: 30px;
            --transition-fast: 0.3s;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            min-height: 100vh;
            padding: var(--spacing-md);
            color: var(--text-secondary);
            line-height: 1.5;
        }
        
        .app-header {
            text-align: center;
            margin-bottom: var(--spacing-xl);
            padding-top: var(--spacing-lg);
        }
        
        .app-header h1 {
            color: var(--text-primary);
            font-size: 2rem;
            margin-bottom: var(--spacing-sm);
            background: var(--gradient-primary);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .app-header p {
            color: var(--text-muted);
            max-width: 600px;
            margin: 0 auto;
            font-size: 0.95rem;
        }
        
        .json-blocks-panel {
            display: flex;
            justify-content: center;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-xl);
            flex-wrap: wrap;
        }
        
        .json-block-btn {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: var(--spacing-md) var(--spacing-lg);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 4px;
            font-weight: 500;
            box-shadow: var(--shadow-md);
            min-width: 200px;
            text-align: left;
        }
        
        .json-block-btn:hover {
            background: var(--border-focus);
            border-color: var(--border-focus);
            transform: translateY(-2px);
        }
        
        .json-block-title {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 1rem;
        }
        
        .json-block-desc {
            font-size: 0.85rem;
            color: var(--text-muted);
            line-height: 1.3;
        }
        
        .editors-container {
            display: flex;
            height: 60vh;
            max-width: 1400px;
            margin: 0 auto 40px;
            position: relative;
        }
        
        @media (max-width: 768px) {
            .editors-container {
                flex-direction: column;
                height: auto;
            }
            
            .splitter {
                display: none;
            }
            
            .json-blocks-panel {
                flex-direction: column;
                align-items: center;
            }
        }
        
        .editor-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-secondary);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
            overflow: hidden;
            min-width: 200px;
        }
        
        .splitter {
            width: 12px;
            cursor: col-resize;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            transition: background-color var(--transition-fast);
            margin: 0 4px;
            flex-shrink: 0;
        }
                
        .splitter-handle {
            width: 4px;
            height: 40px;
            background: var(--border-color);
            border-radius: 2px;
            transition: background-color var(--transition-fast);
        }
        
        .splitter:hover .splitter-handle {
            background: var(--color-primary);
        }
        
        .splitter:active .splitter-handle {
            background: var(--text-primary);
        }
        
        .editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-lg);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-white);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            transition: all var(--transition-fast);
        }
        
        .editor-header.waiting {
            background: var(--gradient-waiting);
        }
        
        .editor-header.valid {
            background: var(--gradient-success);
        }
        
        .editor-header.invalid {
            background: var(--gradient-danger);
        }
        
        .editor-title {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            color: var(--text-white);
            font-weight: 600;
        }
        
        .editor-status {
            font-size: 0.85rem;
            padding: 8px 12px;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.15);
            color: var(--text-white);
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
        }
        
        .editor-status.error {
            background: rgba(255, 255, 255, 0.15);
            color: var(--text-white);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .unicode-toggle {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 16px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            transition: all var(--transition-fast);
        }
        
        .unicode-toggle:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.3);
        }
        
        .unicode-toggle.active {
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .unicode-toggle-label {
            font-size: 0.85rem;
            color: var(--text-white);
            font-weight: 500;
            transition: color var(--transition-fast);
        }
        
        .unicode-toggle.active .unicode-toggle-label {
            color: var(--text-white);
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 20px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #cbcbcb;
            transition: .3s;
            border-radius: 34px;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 2px;
            bottom: 2px;
            background: white;
            transition: .3s;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        input:checked + .toggle-slider {
            background: var(--bg-tertiary);
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(20px);
        }
        
        .editor-container {
            flex: 1;
            display: flex;
            position: relative;
            overflow: hidden;
            background: var(--bg-tertiary);
        }
        
        .line-numbers {
            width: 50px;
            padding: var(--spacing-lg) 8px;
            background: var(--bg-tertiary);
            border-right: 1px solid var(--border-color);
            color: var(--text-muted);
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
            text-align: right;
            overflow-y: auto;
            overflow-x: hidden;
            user-select: none;
            flex-shrink: 0;
            white-space: pre;
        }
        
        .line-numbers::-webkit-scrollbar {
            width: 0;
            display: none;
        }
        
        .editor-content {
            flex: 1;
            padding: var(--spacing-lg);
            background: var(--bg-tertiary);
            border: none;
            color: var(--text-primary);
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
            resize: none;
            outline: none;
            overflow: auto;
        }
        
        .editor-content::placeholder {
            color: #64748b;
            opacity: 0.7;
        }
        
        #inputEditor {
            overflow-wrap: normal;
            overflow-x: auto;
        }
        
        #outputEditor {
            word-break: break-all;
        }
        
        .editor-content::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        .editor-content::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
        }
        
        .editor-content::-webkit-scrollbar-thumb {
            background: var(--border-focus);
            border-radius: 4px;
        }
        
        .editor-content::-webkit-scrollbar-thumb:hover {
            background: var(--color-primary);
        }
        
        .editor-footer {
            padding: var(--spacing-md) var(--spacing-lg);
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: var(--spacing-sm);
            justify-content: flex-end;
            flex-wrap: wrap;
        }
        
        .editor-footer-btn {
            border: 1px solid transparent;
            color: var(--text-white);
            padding: 8px 16px;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .editor-footer-btn[data-action="clear-all"] {
            background: var(--gradient-danger);
        }
        
        .editor-footer-btn[data-action="clear-all"]:hover {
            background: var(--gradient-danger);
            filter: brightness(0.9);
            border-color: transparent;
        }
        
        .editor-footer-btn[data-action="copy-input"],
        .editor-footer-btn[data-action="copy-output"],
        .editor-footer-btn[data-action="fix-json"] {
            background: var(--gradient-success);
        }
        
        .editor-footer-btn[data-action="copy-input"]:hover,
        .editor-footer-btn[data-action="copy-output"]:hover,
        .editor-footer-btn[data-action="fix-json"]:hover {
            background: var(--gradient-success);
            filter: brightness(0.9);
            border-color: transparent;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: var(--spacing-md) var(--spacing-lg);
            border-radius: var(--border-radius);
            background: var(--gradient-success);
            color: white;
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            display: none;
            animation: slideIn 0.3s ease-out;
            max-width: 300px;
        }
        
        .notification.error {
            background: var(--gradient-danger);
        }
        
        .notification.warning {
            background: var(--gradient-warning);
        }
        
        .notification.info {
            background: var(--gradient-info);
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .residence-panel {
            max-width: 1400px;
            margin: 0 auto 40px;
            background: var(--bg-secondary);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
            overflow: hidden;
            display: none;
        }
        
        .residence-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-lg);
            background: var(--gradient-waiting);
            color: var(--text-white);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .residence-header h3 {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }
        
        .residence-content {
            padding: var(--spacing-lg);
            background: var(--bg-tertiary);
            margin: var(--spacing-md);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
            white-space: pre-wrap;
            overflow-x: auto;
            overflow-y: auto;
            max-height: 300px;
        }
        
        .residence-content::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        .residence-content::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
        }
        
        .residence-content::-webkit-scrollbar-thumb {
            background: var(--border-focus);
            border-radius: 4px;
        }
        
        .residence-content::-webkit-scrollbar-thumb:hover {
            background: var(--color-primary);
        }
        
        .residence-buttons {
            display: flex;
            gap: var(--spacing-md);
            padding: var(--spacing-lg);
            justify-content: center;
            flex-wrap: wrap;
            border-top: 1px solid var(--border-color);
        }
        
        .residence-btn {
            border: 1px solid transparent;
            color: var(--text-white);
            padding: var(--spacing-sm) var(--spacing-lg);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            font-weight: 500;
            box-shadow: var(--shadow-md);
        }
        
        .residence-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
            border-color: transparent;
        }
        
        .residence-btn.process {
            background: var(--gradient-info);
        }
        
        .residence-btn.invalid {
            background: var(--gradient-warning);
        }
        
        .reg-status {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-left: 8px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }
        
        .reg-status.reg-status-3 {
            background: var(--gradient-info);
        }
        
        .reg-status.reg-status-6 {
            background: var(--gradient-warning);
        }
        
        .reg-status.reg-status-4 {
            background: var(--gradient-success);
        }
        
        .reg-status.reg-status-7 {
            background: var(--gradient-danger);
        }
        
        .reg-status.reg-status-other {
            background: #334155;
        }
    </style>
</head>
<body>
    <div class="app-header">
        <h1>JSON Editor</h1>
        <p>Редактор для работы с JSON файлом профиля S3</p>
    </div>
    
    <div class="json-blocks-panel">
        <button class="json-block-btn" data-action="copy-residence-address">
            <div class="json-block-title">Блок residenceAddress</div>
            <div class="json-block-desc">Адрес проживания с координатами</div>
        </button>
        <button class="json-block-btn" data-action="copy-residence-registration">
            <div class="json-block-title">Блок residenceRegistration</div>
            <div class="json-block-desc">Регистрационные данные</div>
        </button>
    </div>
    
    <div class="editors-container">
        <div class="editor-section">
            <div class="editor-header waiting" id="inputHeader">
                <div class="editor-title">
                    <i class="fas fa-keyboard"></i>
                    <span>Ввод json профиля</span>
                </div>
                <div class="editor-status" id="inputStatus">Вставьте json текст</div>
            </div>
            <div class="editor-container">
                <div class="line-numbers" id="inputLineNumbers">1</div>
                <textarea class="editor-content" id="inputEditor" placeholder='Введите JSON или текст...'></textarea>
            </div>
            <div class="editor-footer">
                <button class="editor-footer-btn" data-action="clear-all">
                    <i class="fas fa-trash"></i> Очистить
                </button>
                <button class="editor-footer-btn" data-action="fix-json">
                    <i class="fas fa-wrench"></i> Исправить
                </button>
                <button class="editor-footer-btn" data-action="copy-input">
                    <i class="fas fa-copy"></i> Копировать
                </button>
            </div>
        </div>
        
        <div class="splitter" id="splitter">
            <div class="splitter-handle"></div>
        </div>
        
        <div class="editor-section">
            <div class="editor-header waiting" id="outputHeader">
                <div class="editor-title">
                    <i class="fas fa-code"></i>
                    <span id="outputTitle">Вывод профиля</span>
                </div>
                <div class="unicode-toggle" id="unicodeToggle">
                    <span class="unicode-toggle-label">Unicode</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="viewSwitch">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>
            <div class="editor-container">
                <div class="line-numbers" id="outputLineNumbers">1</div>
                <textarea class="editor-content" id="outputEditor" readonly placeholder="Здесь появится результат в Unicode..."></textarea>
            </div>
            <div class="editor-footer">
                <button class="editor-footer-btn" data-action="copy-output">
                    <i class="fas fa-copy"></i> Копировать
                </button>
            </div>
        </div>
    </div>
    
    <div class="residence-panel" id="residencePanel">
        <div class="residence-header">
            <h3>
                <i class="fas fa-home"></i>
                Блок residenceRegistration
                <span id="regStatusBadge" class="reg-status"></span>
            </h3>
        </div>
        <div class="residence-content" id="residenceBlockDisplay"></div>
        <div class="residence-buttons">
            <button class="residence-btn process" id="processMsoBtn" style="display: none;">
                Исправить на 1 статус
            </button>
            <button class="residence-btn invalid" id="invalidMsoBtn" style="display: none;">
                Исправить на 5 статус
            </button>
        </div>
    </div>
    
    <div class="notification" id="notification"></div>

    <script>
        class JSONProcessor {
            constructor() {
                this.isTextViewMode = false;
                this.debounceTimer = null;
                this.unicodeOutput = '';
                this.textOutput = '';
                this.splitterActive = false;
                this.isJsonValid = false;
                this.residenceRegistrationFound = false;
                this.residenceRegistrationBlock = null;
                this.currentRegStatus = null;
                this.currentUnregistrationReasonId = null;
                
                this.jsonBlocks = {
                    'residenceAddress': `"residenceAddress": {
    "addressName": "НЕОБХОДИМО УКАЗАТЬ АДРЕС ИЗ ФИАС https://fias.nalog.ru/",
    "flat": null,
    "city": "НЕОБХОДИМО УКАЗАТЬ ГОРОД",
    "street": "НЕОБХОДИМО УКАЗАТЬ УЛИЦУ",
    "house": "НЕОБХОДИМО УКАЗАТЬ НОМЕР ДОМА",
    "province": "Центральный федеральный округ",
    "point": {
      "lat": НЕОБХОДИМО УКАЗАТЬ КООРДИНАТЫ,
      "lon": НЕОБХОДИМО УКАЗАТЬ КООРДИНАТЫ
    },
    "timestamp": "2025-11-25T10:50:29Z",
    "regDate": null,
    "regStatus": null,
    "changeDate": "2025-11-25T10:50:29Z",
    "vegetation": null,
    "district": null,
    "locality": null,
    "residenceStatus": 4,
    "residenceMessageCode": null
  }`,
                    'residenceRegistration': `"residenceRegistration": {
    "regStatus": 4,
    "unregistrationReasonId": null,
    "statusMessageCode": null,
    "receiveDate": "2025-11-13T23:03:13.335Z",
    "expirationDate": "2029-09-01T00:00:00",
    "isRkl": false,
    "changeDate": "2025-11-13T01:09:55Z"
  }`
                };
                
                this.init();
            }
            
            init() {
                this.bindEvents();
                this.initSplitter();
                this.processInput();
                document.getElementById('inputEditor').focus();
            }
            
            initSplitter() {
                const splitter = document.getElementById('splitter');
                const container = document.querySelector('.editors-container');
                const leftPanel = document.querySelector('.editor-section:first-child');
                const rightPanel = document.querySelector('.editor-section:last-child');
                
                let startX, startLeftWidth, startRightWidth;
                
                splitter.addEventListener('mousedown', (e) => {
                    this.splitterActive = true;
                    startX = e.clientX;
                    startLeftWidth = leftPanel.offsetWidth;
                    startRightWidth = rightPanel.offsetWidth;
                    
                    document.body.style.cursor = 'col-resize';
                    
                    const handleMouseMove = (e) => {
                        if (!this.splitterActive) return;
                        
                        const containerWidth = container.offsetWidth;
                        const splitterWidth = splitter.offsetWidth;
                        const deltaX = e.clientX - startX;
                        
                        let newLeftWidth = startLeftWidth + deltaX;
                        let newRightWidth = startRightWidth - deltaX;
                        
                        const minWidth = 500;
                        const maxWidth = containerWidth - splitterWidth - minWidth;
                        
                        newLeftWidth = Math.max(minWidth, Math.min(maxWidth, newLeftWidth));
                        newRightWidth = containerWidth - splitterWidth - newLeftWidth;
                        
                        leftPanel.style.width = `${newLeftWidth}px`;
                        leftPanel.style.flex = `0 0 ${newLeftWidth}px`;
                        rightPanel.style.width = `${newRightWidth}px`;
                        rightPanel.style.flex = `0 0 ${newRightWidth}px`;
                    };
                    
                    const handleMouseUp = () => {
                        this.splitterActive = false;
                        document.body.style.cursor = '';
                        
                        document.removeEventListener('mousemove', handleMouseMove);
                        document.removeEventListener('mouseup', handleMouseUp);
                        
                        this.updateLineNumbers('inputLineNumbers', 'inputEditor');
                        this.updateLineNumbers('outputLineNumbers', 'outputEditor');
                    };
                    
                    document.addEventListener('mousemove', handleMouseMove);
                    document.addEventListener('mouseup', handleMouseUp);
                });
            }
            
            bindEvents() {
                const inputEditor = document.getElementById('inputEditor');
                const inputLineNumbers = document.getElementById('inputLineNumbers');
                
                inputEditor.addEventListener('input', () => {
                    this.updateLineNumbers('inputLineNumbers', 'inputEditor');
                    this.debounceProcess();
                });
                
                inputEditor.addEventListener('scroll', () => {
                    inputLineNumbers.scrollTop = inputEditor.scrollTop;
                });
                
                document.addEventListener('click', (e) => {
                    const button = e.target.closest('[data-action]');
                    if (button) {
                        const action = button.dataset.action;
                        this.handleAction(action);
                    }
                });
                
                document.getElementById('processMsoBtn').addEventListener('click', () => {
                    this.fixResidenceRegistration(1);
                });
                
                document.getElementById('invalidMsoBtn').addEventListener('click', () => {
                    this.fixResidenceRegistration(5);
                });
                
                document.getElementById('viewSwitch').addEventListener('change', () => {
                    this.toggleViewMode();
                });
                
                this.updateLineNumbers('inputLineNumbers', 'inputEditor');
                this.updateLineNumbers('outputLineNumbers', 'outputEditor');
            }
            
            handleAction(action) {
                switch(action) {
                    case 'clear-all':
                        this.clearAll();
                        break;
                    case 'copy-input':
                        this.copyToClipboard('inputEditor');
                        break;
                    case 'copy-output':
                        this.copyToClipboard('outputEditor');
                        break;
                    case 'fix-json':
                        this.fixJsonStructure();
                        break;
                    case 'copy-residence-address':
                        this.copyJsonBlock('residenceAddress');
                        break;
                    case 'copy-residence-registration':
                        this.copyJsonBlock('residenceRegistration');
                        break;
                }
            }
            
            fixJsonStructure() {
                try {
                    const input = document.getElementById('inputEditor').value;
                    if (!input.trim()) {
                        this.showNotification('Введите JSON для исправления', true);
                        return;
                    }
                    
                    const json = JSON.parse(input);
                    const template = {
                        "uuid": null,
                        "graphNumber": null,
                        "issueDate": null,
                        "expirationDate": null,
                        "surname": "",
                        "name": "",
                        "patronymic": "",
                        "citizenship": "",
                        "language": "ru",
                        "galleryId": null,
                        "timestamp": null,
                        "receivedDate": null,
                        "status": {
                            "statusUser": null,
                            "authEndDate": null,
                            "authHash": null,
                            "idIdn": null,
                            "statusIdn": null,
                            "statusIdnChangeDate": null,
                            "dateIdn": null,
                            "untilIdn": null,
                            "dateResult": null
                        },
                        "residenceAddress": {
                            "addressName": null,
                            "flat": null,
                            "city": null,
                            "street": null,
                            "house": null,
                            "province": null,
                            "point": {
                                "lat": null,
                                "lon": null
                            },
                            "timestamp": null,
                            "changeDate": null,
                            "vegetation": null,
                            "district": null,
                            "locality": null,
                            "residenceStatus": null,
                            "residenceMessageCode": null,
                            "residenceUnblockedDate": null
                        },
                        "residenceRegistration": {
                            "regStatus": 4,
                            "unregistrationReasonId": null,
                            "statusMessageCode": null,
                            "receiveDate": "2025-11-13T23:03:13.335Z",
                            "expirationDate": "2029-09-01T00:00:00",
                            "changeDate": "2025-11-13T01:09:55Z"
                        },
                        "residenceReply": {
                            "residenceRegistrationStatus": null,
                            "regDate": null
                        },
                        "verification": {
                            "number": null,
                            "isVerified": null,
                            "verificationDate": null,
                            "timeoutDate": null,
                            "changeDate": null
                        },
                        "rkl": {
                            "isRkl": null,
                            "receiveDate": null
                        }
                    };
                    
                    // Удаляем блоки foreignCards и mobile если они есть
                    if (json.foreignCards) delete json.foreignCards;
                    if (json.mobile) delete json.mobile;
                    
                    // Исправляем language если он пустой
                    if (json.language === "") {
                        json.language = "ru";
                    }
                    
                    // Убираем galleryId если его нет в исходном
                    if (!json.hasOwnProperty('galleryId')) {
                        delete template.galleryId;
                    }
                    
                    // Создаем исправленный JSON
                    const fixedJson = {};
                    
                    // Копируем поля верхнего уровня из template
                    Object.keys(template).forEach(key => {
                        if (key === 'galleryId' && !json.hasOwnProperty('galleryId')) {
                            return;
                        }
                        
                        if (json.hasOwnProperty(key)) {
                            if (typeof template[key] === 'object' && template[key] !== null && !Array.isArray(template[key])) {
                                // Для вложенных объектов обрабатываем отдельно
                                if (key === 'status' && json.status) {
                                    fixedJson.status = {};
                                    Object.keys(template.status).forEach(subKey => {
                                        if (json.status.hasOwnProperty(subKey)) {
                                            fixedJson.status[subKey] = json.status[subKey];
                                        }
                                    });
                                } else if (key === 'residenceAddress' && json.residenceAddress) {
                                    fixedJson.residenceAddress = {};
                                    Object.keys(template.residenceAddress).forEach(subKey => {
                                        if (json.residenceAddress.hasOwnProperty(subKey)) {
                                            fixedJson.residenceAddress[subKey] = json.residenceAddress[subKey];
                                        }
                                    });
                                    // Добавляем regDate только если он есть
                                    if (json.residenceAddress.regDate !== undefined) {
                                        fixedJson.residenceAddress.regDate = json.residenceAddress.regDate;
                                    }
                                } else if (key === 'residenceRegistration' && json.residenceRegistration) {
                                    fixedJson.residenceRegistration = {
                                        "regStatus": 4,
                                        "unregistrationReasonId": null,
                                        "statusMessageCode": null,
                                        "receiveDate": "2025-11-13T23:03:13.335Z",
                                        "expirationDate": "2029-09-01T00:00:00",
                                        "changeDate": "2025-11-13T01:09:55Z"
                                    };
                                    
                                    // Копируем существующие значения, но только те, которые есть в template
                                    Object.keys(template.residenceRegistration).forEach(subKey => {
                                        if (json.residenceRegistration[subKey] !== undefined) {
                                            fixedJson.residenceRegistration[subKey] = json.residenceRegistration[subKey];
                                        }
                                    });
                                } else if (key === 'residenceReply' && json.residenceReply) {
                                    fixedJson.residenceReply = {};
                                    Object.keys(template.residenceReply).forEach(subKey => {
                                        if (json.residenceReply.hasOwnProperty(subKey)) {
                                            fixedJson.residenceReply[subKey] = json.residenceReply[subKey];
                                        }
                                    });
                                } else if (key === 'verification' && json.verification) {
                                    fixedJson.verification = {};
                                    Object.keys(template.verification).forEach(subKey => {
                                        if (json.verification.hasOwnProperty(subKey)) {
                                            fixedJson.verification[subKey] = json.verification[subKey];
                                        }
                                    });
                                } else if (key === 'rkl') {
                                    // Обрабатываем блок rkl согласно новым требованиям
                                    // Если есть isRkl и receiveDate в residenceRegistration, создаем блок rkl
                                    if (json.residenceRegistration && 
                                        json.residenceRegistration.isRkl !== undefined && 
                                        json.residenceRegistration.receiveDate !== undefined) {
                                        
                                        fixedJson.rkl = {
                                            "isRkl": json.residenceRegistration.isRkl,
                                            "receiveDate": json.residenceRegistration.receiveDate
                                        };
                                    } else if (json.rkl) {
                                        // Если исходный JSON уже содержит блок rkl, копируем его
                                        fixedJson.rkl = {};
                                        Object.keys(template.rkl).forEach(subKey => {
                                            if (json.rkl.hasOwnProperty(subKey)) {
                                                fixedJson.rkl[subKey] = json.rkl[subKey];
                                            }
                                        });
                                    } else {
                                        // Иначе оставляем значения по умолчанию
                                        fixedJson.rkl = { ...template.rkl };
                                    }
                                } else {
                                    fixedJson[key] = json[key];
                                }
                            } else {
                                fixedJson[key] = json[key];
                            }
                        } else {
                            fixedJson[key] = template[key];
                        }
                    });
                    
                    // Копируем остальные поля из исходного JSON (которые не в template)
                    Object.keys(json).forEach(key => {
                        if (!template.hasOwnProperty(key) && key !== 'foreignCards' && key !== 'mobile') {
                            fixedJson[key] = json[key];
                        }
                    });
                    
                    // Форматируем и обновляем редактор
                    const formatted = JSON.stringify(fixedJson, null, 2);
                    document.getElementById('inputEditor').value = formatted;
                    
                    // Обновляем состояние
                    this.processInput();
                    this.showNotification('JSON исправлен согласно эталонной структуре');
                    
                } catch (error) {
                    this.showNotification(`Ошибка при исправлении JSON: ${error.message}`, true);
                }
            }
            
            copyJsonBlock(blockName) {
                const block = this.jsonBlocks[blockName];
                if (!block) {
                    this.showNotification(`Блок ${blockName} не найден`, true);
                    return;
                }
                
                navigator.clipboard.writeText(block).then(() => {
                    this.showNotification(`Блок ${blockName} скопирован в буфер обмена`);
                }).catch(() => {
                    this.showNotification('Ошибка копирования', true);
                });
            }
            
            debounceProcess() {
                clearTimeout(this.debounceTimer);
                this.debounceTimer = setTimeout(() => {
                    this.processInput();
                }, 300);
            }
            
            processInput() {
                const input = document.getElementById('inputEditor').value;
                const inputStatus = document.getElementById('inputStatus');
                const inputHeader = document.getElementById('inputHeader');
                const outputHeader = document.getElementById('outputHeader');
                const unicodeToggle = document.getElementById('unicodeToggle');
                
                inputHeader.className = 'editor-header';
                outputHeader.className = 'editor-header';
                
                if (input.trim()) {
                    try {
                        const parsed = JSON.parse(input);
                        const formatted = JSON.stringify(parsed, null, 2);
                        document.getElementById('inputEditor').value = formatted;
                        inputStatus.textContent = 'Json валиден';
                        inputStatus.className = 'editor-status';
                        
                        inputHeader.classList.add('valid');
                        outputHeader.classList.add('valid');
                        unicodeToggle.classList.add('active');
                        this.isJsonValid = true;
                        
                        this.findResidenceRegistration(parsed);
                        this.processOutput(input);
                    } catch (e) {
                        inputStatus.textContent = 'Ошибка чтения json';
                        inputStatus.className = 'editor-status error';
                        
                        inputHeader.classList.add('invalid');
                        outputHeader.classList.add('invalid');
                        unicodeToggle.classList.remove('active');
                        this.isJsonValid = false;
                        
                        this.hideResidencePanel();
                        this.clearOutput();
                    }
                } else {
                    inputStatus.textContent = 'Вставьте json текст';
                    inputStatus.className = 'editor-status';
                    
                    inputHeader.classList.add('waiting');
                    outputHeader.classList.add('waiting');
                    unicodeToggle.classList.remove('active');
                    this.isJsonValid = false;
                    
                    this.hideResidencePanel();
                    this.clearOutput();
                }
                
                this.updateLineNumbers('inputLineNumbers', 'inputEditor');
            }
            
            findResidenceRegistration(obj) {
                this.residenceRegistrationFound = false;
                this.residenceRegistrationBlock = null;
                this.currentRegStatus = null;
                this.currentUnregistrationReasonId = null;
                
                const search = (currentObj) => {
                    if (!currentObj || typeof currentObj !== 'object') return;
                    
                    if (currentObj.hasOwnProperty('residenceRegistration')) {
                        this.residenceRegistrationFound = true;
                        this.residenceRegistrationBlock = currentObj.residenceRegistration;
                        
                        if (this.residenceRegistrationBlock) {
                            this.currentRegStatus = this.residenceRegistrationBlock.regStatus;
                            this.currentUnregistrationReasonId = this.residenceRegistrationBlock.unregistrationReasonId;
                        }
                        
                        this.displayResidencePanel();
                        return true;
                    }
                    
                    for (const key in currentObj) {
                        if (typeof currentObj[key] === 'object' && currentObj[key] !== null) {
                            if (search(currentObj[key])) {
                                return true;
                            }
                        }
                    }
                    
                    return false;
                };
                
                search(obj);
                
                if (!this.residenceRegistrationFound) {
                    this.hideResidencePanel();
                }
            }
            
            displayResidencePanel() {
                const panel = document.getElementById('residencePanel');
                const display = document.getElementById('residenceBlockDisplay');
                const statusBadge = document.getElementById('regStatusBadge');
                const processBtn = document.getElementById('processMsoBtn');
                const invalidBtn = document.getElementById('invalidMsoBtn');
                
                if (!this.residenceRegistrationBlock) {
                    panel.style.display = 'none';
                    return;
                }
                
                const formattedBlock = JSON.stringify(this.residenceRegistrationBlock, null, 2);
                display.textContent = formattedBlock;
                
                if (this.currentRegStatus !== null) {
                    let statusText = `regStatus: ${this.currentRegStatus}`;
                    if (this.currentUnregistrationReasonId !== null) {
                        statusText += `, reasonId: ${this.currentUnregistrationReasonId}`;
                    }
                    statusBadge.textContent = statusText;
                    
                    statusBadge.className = 'reg-status';
                    
                    if (this.currentRegStatus === 3) {
                        statusBadge.classList.add('reg-status-3');
                    } else if (this.currentRegStatus === 6) {
                        statusBadge.classList.add('reg-status-6');
                    } else if (this.currentRegStatus === 4) {
                        statusBadge.classList.add('reg-status-4');
                    } else if (this.currentRegStatus === 7) {
                        statusBadge.classList.add('reg-status-7');
                    } else {
                        statusBadge.classList.add('reg-status-other');
                    }
                } else {
                    statusBadge.textContent = 'regStatus: не найден';
                    statusBadge.className = 'reg-status reg-status-other';
                }
                
                const shouldShowProcessBtn = 
                    this.currentRegStatus === 3 || 
                    (this.currentRegStatus === 7 && 
                     (this.currentUnregistrationReasonId === 1 || this.currentUnregistrationReasonId === 3));
                
                const shouldShowInvalidBtn = this.currentRegStatus === 6;
                
                processBtn.style.display = shouldShowProcessBtn ? 'flex' : 'none';
                invalidBtn.style.display = shouldShowInvalidBtn ? 'flex' : 'none';
                
                panel.style.display = 'block';
                panel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
            
            hideResidencePanel() {
                const panel = document.getElementById('residencePanel');
                panel.style.display = 'none';
                this.residenceRegistrationFound = false;
                this.residenceRegistrationBlock = null;
                this.currentRegStatus = null;
                this.currentUnregistrationReasonId = null;
            }
            
            fixResidenceRegistration(newStatus) {
                if (!this.residenceRegistrationFound || !this.residenceRegistrationBlock) {
                    this.showNotification('Блок residenceRegistration не найден', true);
                    return;
                }
                
                try {
                    const input = document.getElementById('inputEditor').value;
                    const parsed = JSON.parse(input);
                    
                    const replaceRegStatus = (obj) => {
                        if (!obj || typeof obj !== 'object') return false;
                        
                        if (obj.hasOwnProperty('residenceRegistration') && 
                            obj.residenceRegistration && 
                            obj.residenceRegistration.hasOwnProperty('regStatus')) {
                            
                            const oldStatus = obj.residenceRegistration.regStatus;
                            const oldReasonId = obj.residenceRegistration.unregistrationReasonId;
                            
                            obj.residenceRegistration.regStatus = newStatus;
                            
                            if (oldStatus === 7 && (oldReasonId === 1 || oldReasonId === 3) && newStatus === 1) {
                                obj.residenceRegistration.unregistrationReasonId = null;
                            }
                            
                            this.residenceRegistrationBlock = obj.residenceRegistration;
                            this.currentRegStatus = newStatus;
                            this.currentUnregistrationReasonId = obj.residenceRegistration.unregistrationReasonId;
                            
                            let message = `regStatus изменен с ${oldStatus} на ${newStatus === 1 ? '1 (Process МСО)' : '5 (Невалидные данные МСО)'}`;
                            if (oldStatus === 7 && (oldReasonId === 1 || oldReasonId === 3)) {
                                message += ', unregistrationReasonId изменен на null';
                            }
                            
                            this.showNotification(message, false, 'info');
                            
                            return true;
                        }
                        
                        for (const key in obj) {
                            if (typeof obj[key] === 'object' && obj[key] !== null) {
                                if (replaceRegStatus(obj[key])) {
                                    return true;
                                }
                            }
                        }
                        
                        return false;
                    };
                    
                    if (replaceRegStatus(parsed)) {
                        const formatted = JSON.stringify(parsed, null, 2);
                        document.getElementById('inputEditor').value = formatted;
                        
                        this.displayResidencePanel();
                        this.processOutput(formatted);
                        this.updateLineNumbers('inputLineNumbers', 'inputEditor');
                    } else {
                        this.showNotification('Не удалось найти regStatus для замены', true);
                    }
                } catch (e) {
                    this.showNotification('Ошибка при обработке JSON', true);
                }
            }
            
            processOutput(input) {
                if (!this.isJsonValid || !input.trim()) {
                    this.clearOutput();
                    return;
                }
                
                try {
                    const parsed = JSON.parse(input);
                    const minified = JSON.stringify(parsed);
                    this.unicodeOutput = this.textToUnicode(minified);
                    this.textOutput = this.unicodeToText(this.unicodeOutput);
                    this.updateOutputDisplay();
                } catch (e) {
                    this.clearOutput();
                }
            }
            
            textToUnicode(text) {
                let result = '';
                for (let i = 0; i < text.length; i++) {
                    const char = text[i];
                    const code = char.charCodeAt(0);
                    if (code > 127) {
                        result += '\\u' + code.toString(16).toUpperCase().padStart(4, '0');
                    } else {
                        result += char;
                    }
                }
                return result;
            }
            
            unicodeToText(text) {
                return text.replace(/\\u[0-9A-Fa-f]{4}/g, (match) => {
                    return String.fromCharCode(parseInt(match.replace('\\u', ''), 16));
                });
            }
            
            toggleViewMode() {
                if (!this.isJsonValid) {
                    document.getElementById('viewSwitch').checked = false;
                    this.showNotification('Невозможно переключить режим: JSON невалиден', true);
                    return;
                }
                
                this.isTextViewMode = document.getElementById('viewSwitch').checked;
                this.updateOutputDisplay();
            }
            
            updateOutputDisplay() {
                if (!this.isJsonValid) {
                    document.getElementById('outputEditor').value = '';
                    this.updateLineNumbers('outputLineNumbers', 'outputEditor');
                    return;
                }
                
                const output = this.isTextViewMode ? this.textOutput : this.unicodeOutput;
                document.getElementById('outputEditor').value = output;
                this.updateLineNumbers('outputLineNumbers', 'outputEditor');
            }
            
            clearOutput() {
                this.unicodeOutput = '';
                this.textOutput = '';
                document.getElementById('outputEditor').value = '';
                document.getElementById('viewSwitch').checked = false;
                this.isTextViewMode = false;
                this.updateLineNumbers('outputLineNumbers', 'outputEditor');
            }
            
            updateLineNumbers(lineNumbersId, editorId) {
                const editor = document.getElementById(editorId);
                const lineNumbers = document.getElementById(lineNumbersId);
                const lines = editor.value.split('\n').length;
                
                const scrollTop = editor.scrollTop;
                let numbers = '';
                
                for (let i = 1; i <= lines; i++) {
                    numbers += i + '\n';
                }
                
                lineNumbers.innerHTML = numbers;
                editor.scrollTop = scrollTop;
                lineNumbers.scrollTop = scrollTop;
            }
            
            clearAll() {
                document.getElementById('inputEditor').value = '';
                document.getElementById('outputEditor').value = '';
                document.getElementById('inputStatus').textContent = 'Ожидание ввода...';
                document.getElementById('inputStatus').className = 'editor-status';
                document.getElementById('inputEditor').focus();
                
                const inputHeader = document.getElementById('inputHeader');
                const outputHeader = document.getElementById('outputHeader');
                inputHeader.className = 'editor-header waiting';
                outputHeader.className = 'editor-header waiting';
                
                document.getElementById('unicodeToggle').classList.remove('active');
                this.isJsonValid = false;
                
                this.hideResidencePanel();
                this.clearOutput();
                
                this.updateLineNumbers('inputLineNumbers', 'inputEditor');
                this.showNotification('Все поля очищены');
            }
            
            copyToClipboard(editorId) {
                const editor = document.getElementById(editorId);
                const text = editor.value;
                
                if (!text.trim()) {
                    this.showNotification('Нет данных для копирования', true);
                    return;
                }
                
                navigator.clipboard.writeText(text).then(() => {
                    const editorName = editorId === 'inputEditor' ? 'Ввод' : 'Вывод';
                    this.showNotification(`${editorName} скопирован в буфер`);
                }).catch(() => {
                    this.showNotification('Ошибка копирования', true);
                });
            }
            
            showNotification(message, isError = false, type = '') {
                const notification = document.getElementById('notification');
                notification.textContent = message;
                notification.className = `notification ${isError ? 'error' : type}`;
                notification.style.display = 'block';
                
                setTimeout(() => {
                    notification.style.display = 'none';
                }, 3000);
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            window.processor = new JSONProcessor();
        });
    </script>
</body>
</html>